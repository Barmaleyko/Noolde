var PostgresClient=require("./lib/PostgresClient").PostgresClient;
//var Config=require("../Config");
var sys=require("sys");
var net=require("net");

var client=new PostgresClient(Config.dbInfo);
client.on("error",function(err) {
	sys.puts("Error: "+err+" "+err.stack);
});
client.on("connect",function() {
	sys.puts("Connect");
});
client.on("end",function() {
	sys.puts("End");
});

var bl0=client.startBlock();
var bl1=client.startBlock();
var bl2=client.startBlock();

client.simpleQuery("SELECT 1;",bl0,function(err,rows,result) {
	if (err) {
		sys.puts("Error:"+err);
		client.endBlock(bl0);
		return;
	}
	sys.puts("Got "+rows[0][0]);
	client.simpleQuery("SELECT 2;",bl0,function(err,rows,result) {
		if (err) {
			sys.puts("Error:"+err);
			client.endBlock(bl0);
			return;
		}
		sys.puts("Got "+rows[0][0]);
		client.simpleQuery("SELECT 3;",bl0,function(err,rows,result) {
			if (err) {
				sys.puts("Error:"+err);
				client.endBlock(bl0);
				return;
			}
			sys.puts("Got "+rows[0][0]);
			setTimeout(function() {
				sys.puts("Ending block 0");
				client.endBlock(bl0);
			},500);
		});
	});
});

client.simpleQuery("SELECT 4;",bl1,function(err,rows,result) {
	if (err) {
		sys.puts("Error:"+err);
		client.endBlock(bl1);
		return;
	}
	sys.puts("Got "+rows[0][0]);
	var bl1_1=client.startBlock(bl1);
	try {
		client.simpleQuery("SELECT 5",bl1_1,function(err,rows,result) {
			if (err) {
				sys.puts("Error:"+err);
				client.endBlock(bl1_1);
				return;
			}
			sys.puts("Got "+rows[0][0]);
			client.simpleQuery("SELECT 6;",bl1_1,function(err,rows,result) {
				if (err) {
					sys.puts("Error:"+err);
					client.endBlock(bl1_1);
					return;
				}
				sys.puts("Got "+rows[0][0]);
				setTimeout(function() {
					sys.puts("Ending block 1.1");
					client.endBlock(bl1_1);
				},500);
			});
		});
	}
	catch(e) {
		sys.puts("Caught");
		sys.puts(e.stack);
	}
	client.simpleQuery("SELECT 7;",bl1,function(err,rows,result) {
		if (err) {
			sys.puts("Error:"+err);
			client.endBlock(bl1);
			return;
		}
		sys.puts("Got "+rows[0][0]);
		client.simpleQuery("SELECT 8;",bl1,function(err,rows,result) {
			if (err) {
				sys.puts("Error:"+err);
				client.endBlock(bl1);
				return;
			}
			sys.puts("Got "+rows[0][0]);
			setTimeout(function() {
				sys.puts("Ending block 1");
				client.endBlock(bl1);
			},500);
		});
	});
});

client.simpleQuery("SELECT 9;",bl2,function(err,rows,result) {
	if (err) {
		sys.puts("Error:"+err);
		client.endBlock(bl2);
		return;
	}
	sys.puts("Got "+rows[0][0]);
	setTimeout(function() {
		sys.puts("Ending block 2");
		client.endBlock(bl2);
	},500);
});

client.simpleQuery("SELECT 10",function(err,rows,result) {
	if (err) {
		sys.puts("Error:"+err);
		client.end();
		return;
	}
	sys.puts("Got "+rows[0][0]);
	client.end();
});